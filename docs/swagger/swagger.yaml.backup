openapi: 3.0.3
info:
  title: Claude Workspace API
  description: |
    A beautifully crafted workspace interface for Claude Code with real-time streaming and local SQLite database.

    This API provides endpoints for task management, git operations, file browsing, search, and AI-powered code assistance.
  version: 0.1.25
  contact:
    name: Claude Workspace
    url: https://github.com/Claude-Workspace/claude-ws
  license:
    name: MIT
    url: https://github.com/Claude-Workspace/claude-ws/blob/main/LICENSE

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: http://localhost:3001
    description: Alternative local port

tags:
  - name: Attempts
    description: Task attempt management
  - name: Checkpoints
    description: Conversation checkpoint operations
  - name: Commands
    description: Claude Code slash commands
  - name: Files
    description: File system operations
  - name: Git
    description: Git repository operations
  - name: Projects
    description: Project management
  - name: Search
    description: Search operations
  - name: Tasks
    description: Task management
  - name: Uploads
    description: File upload management
  - name: Code
    description: Code editing operations
  - name: Language
    description: Language service operations

paths:
  /api/attempts/{id}/status:
    get:
      tags:
        - Attempts
      summary: Get attempt status
      description: Lightweight endpoint to get only the status of an attempt
      operationId: getAttemptStatus
      parameters:
        - name: id
          in: path
          required: true
          description: Attempt ID
          schema:
            type: string
      responses:
        '200':
          description: Status retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [running, completed, failed, cancelled]
        '404':
          description: Attempt not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/checkpoints/backfill:
    post:
      tags:
        - Checkpoints
      summary: Backfill checkpoints
      description: Creates checkpoints for existing completed attempts that don't have one
      operationId: backfillCheckpoints
      responses:
        '200':
          description: Checkpoints backfilled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  created:
                    type: integer
                    description: Number of checkpoints created
                  skipped:
                    type: integer
                    description: Number of attempts skipped
                  total:
                    type: integer
                    description: Total completed attempts processed
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/commands:
    get:
      tags:
        - Commands
      summary: List available commands
      description: Get a list of all available Claude Code slash commands (built-in and user-defined)
      operationId: listCommands
      responses:
        '200':
          description: Commands retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CommandInfo'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/commands/{name}:
    get:
      tags:
        - Commands
      summary: Get command content
      description: Get the content and metadata of a specific command
      operationId: getCommand
      parameters:
        - name: name
          in: path
          required: true
          description: Command name
          schema:
            type: string
        - name: subcommand
          in: query
          description: Subcommand name (if command is a group)
          schema:
            type: string
      responses:
        '200':
          description: Command retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandDetail'
        '404':
          description: Command not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
        - Commands
      summary: Process command with arguments
      description: Process a command by replacing $ARGUMENTS placeholder with actual arguments
      operationId: processCommand
      parameters:
        - name: name
          in: path
          required: true
          description: Command name
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                arguments:
                  type: string
                  description: Arguments to substitute for $ARGUMENTS placeholder
                subcommand:
                  type: string
                  description: Subcommand name (if command is a group)
      responses:
        '200':
          description: Command processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandDetail'
        '404':
          description: Command not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/files:
    get:
      tags:
        - Files
      summary: List directory tree
      description: Get a recursive file tree for a directory with git status
      operationId: listFiles
      parameters:
        - name: path
          in: query
          required: true
          description: Base directory path
          schema:
            type: string
        - name: depth
          in: query
          description: Maximum depth to traverse (default: 10)
          schema:
            type: integer
            default: 10
        - name: showHidden
          in: query
          description: Show hidden files (default: true)
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: File tree retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  entries:
                    type: array
                    items:
                      $ref: '#/components/schemas/FileEntry'
                  basePath:
                    type: string
        '400':
          description: Invalid path
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Path does not exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/files/search:
    get:
      tags:
        - Files
      summary: Search files by name
      description: Search for files by name with fuzzy matching
      operationId: searchFiles
      parameters:
        - name: basePath
          in: query
          required: true
          description: Base directory path
          schema:
            type: string
        - name: query
          in: query
          required: true
          description: Search query
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum results (default: 10)
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/SearchResult'
        '400':
          description: Missing basePath
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/git/discard:
    post:
      tags:
        - Git
      summary: Discard changes
      description: Discard file changes or all changes
      operationId: discardChanges
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - projectPath
              properties:
                projectPath:
                  type: string
                  description: Path to the git repository
                files:
                  type: array
                  items:
                    type: string
                  description: Array of file paths to discard
                all:
                  type: boolean
                  description: Discard all changes
      responses:
        '200':
          description: Changes discarded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Invalid file path
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/git/diff:
    get:
      tags:
        - Git
      summary: Get git diff
      description: Get diff output with addition/deletion counts
      operationId: getGitDiff
      parameters:
        - name: path
          in: query
          required: true
          description: Path to the git repository
          schema:
            type: string
        - name: file
          in: query
          description: Specific file to get diff for
          schema:
            type: string
        - name: staged
          in: query
          description: Get staged changes instead of unstaged
          schema:
            type: boolean
      responses:
        '200':
          description: Diff retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GitDiff'
        '400':
          description: Invalid request or not a git repository
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Invalid file path
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '504':
          description: Git command timed out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/git/fetch:
    post:
      tags:
        - Git
      summary: Fetch from remote
      description: Fetch changes from all remotes
      operationId: fetchGit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - projectPath
              properties:
                projectPath:
                  type: string
                  description: Path to the git repository
      responses:
        '200':
          description: Fetch successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '400':
          description: Invalid project path
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Fetch failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/git/log:
    get:
      tags:
        - Git
      summary: Get git log
      description: Get commit history with branch information
      operationId: getGitLog
      parameters:
        - name: path
          in: query
          required: true
          description: Path to the git repository
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum number of commits (default: 50)
          schema:
            type: integer
            default: 50
        - name: filter
          in: query
          description: Filter: 'current' for HEAD only, 'all' for all branches
          schema:
            type: string
            enum: [current, all]
            default: current
      responses:
        '200':
          description: Commit history retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  commits:
                    type: array
                    items:
                      $ref: '#/components/schemas/GitCommit'
                  head:
                    type: string
                    description: Current HEAD commit hash
        '400':
          description: Invalid path or not a git repository
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/git/pull:
    post:
      tags:
        - Git
      summary: Pull from remote
      description: Pull changes from remote with rebase
      operationId: pullGit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - projectPath
              properties:
                projectPath:
                  type: string
                  description: Path to the git repository
      responses:
        '200':
          description: Pull successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '400':
          description: No upstream branch configured or invalid path
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Merge conflict detected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Pull failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/git/stage:
    post:
      tags:
        - Git
      summary: Stage files
      description: Stage file(s) for commit
      operationId: stageFiles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - projectPath
              properties:
                projectPath:
                  type: string
                  description: Path to the git repository
                files:
                  type: array
                  items:
                    type: string
                  description: Array of file paths to stage
                all:
                  type: boolean
                  description: Stage all changes
      responses:
        '200':
          description: Files staged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Invalid file path
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
        - Git
      summary: Unstage files
      description: Unstage file(s) from commit
      operationId: unstageFiles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - projectPath
              properties:
                projectPath:
                  type: string
                  description: Path to the git repository
                files:
                  type: array
                  items:
                    type: string
                  description: Array of file paths to unstage
                all:
                  type: boolean
                  description: Unstage all changes
      responses:
        '200':
          description: Files unstaged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/git/status:
    get:
      tags:
        - Git
      summary: Get git status
      description: Get repository status including staged, unstaged, and untracked files
      operationId: getGitStatus
      parameters:
        - name: path
          in: query
          required: true
          description: Path to the git repository
          schema:
            type: string
      responses:
        '200':
          description: Git status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GitStatus'
        '400':
          description: Invalid path or not a git repository
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '504':
          description: Git command timed out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/projects/{id}:
    get:
      tags:
        - Projects
      summary: Get project
      description: Get a single project by ID
      operationId: getProject
      parameters:
        - name: id
          in: path
          required: true
          description: Project ID
          schema:
            type: string
      responses:
        '200':
          description: Project retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags:
        - Projects
      summary: Update project
      description: Update project name or path
      operationId: updateProject
      parameters:
        - name: id
          in: path
          required: true
          description: Project ID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: New project name
                path:
                  type: string
                  description: New project path
      responses:
        '200':
          description: Project updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '400':
          description: At least one field required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Project with this path already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
        - Projects
      summary: Delete project
      description: Delete a project by ID
      operationId: deleteProject
      parameters:
        - name: id
          in: path
          required: true
          description: Project ID
          schema:
            type: string
      responses:
        '200':
          description: Project deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/projects/{id}/settings:
    get:
      tags:
        - Projects
      summary: Get project settings
      description: Fetch project settings from .claude/project-settings.json
      operationId: getProjectSettings
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Project ID
          schema:
            type: string
      responses:
        '200':
          description: Settings retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  settings:
                    $ref: '#/components/schemas/ProjectSettings'
        '401':
          description: Unauthorized - Invalid API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Project or settings not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
        - Projects
      summary: Update project settings
      description: Update project settings in .claude/project-settings.json
      operationId: updateProjectSettings
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Project ID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - settings
              properties:
                settings:
                  $ref: '#/components/schemas/ProjectSettings'
      responses:
        '200':
          description: Settings updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  settings:
                    $ref: '#/components/schemas/ProjectSettings'
        '401':
          description: Unauthorized - Invalid API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: Missing settings in request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/search/content:
    get:
      tags:
        - Search
      summary: Search file contents
      description: Grep-like content search in files
      operationId: searchContent
      parameters:
        - name: q
          in: query
          required: true
          description: Search query
          schema:
            type: string
        - name: basePath
          in: query
          required: true
          description: Project root path
          schema:
            type: string
        - name: caseSensitive
          in: query
          description: Case sensitive search (default: false)
          schema:
            type: boolean
        - name: regex
          in: query
          description: Use regex pattern (default: false)
          schema:
            type: boolean
        - name: wholeWord
          in: query
          description: Match whole words only (default: false)
          schema:
            type: boolean
        - name: limit
          in: query
          description: Max results per file (default: 100)
          schema:
            type: integer
            default: 100
        - name: maxFiles
          in: query
          description: Max files to return (default: 50)
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/ContentSearchResult'
                  totalMatches:
                    type: integer
                  filesSearched:
                    type: integer
                  query:
                    type: string
        '400':
          description: Missing parameters or invalid regex
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/search/files:
    get:
      tags:
        - Search
      summary: Fuzzy search files
      description: Fuzzy search for files by name
      operationId: fuzzySearchFiles
      parameters:
        - name: q
          in: query
          description: Search query (empty returns all files)
          schema:
            type: string
        - name: basePath
          in: query
          required: true
          description: Project root path
          schema:
            type: string
        - name: limit
          in: query
          description: Max results (default: 50)
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/FileSearchResult'
                  total:
                    type: integer
                    description: Total matching files
        '400':
          description: Missing basePath
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Path does not exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tasks/{id}/attempts:
    get:
      tags:
        - Tasks
      summary: List task attempts
      description: Get all attempts for a specific task
      operationId: listTaskAttempts
      parameters:
        - name: id
          in: path
          required: true
          description: Task ID
          schema:
            type: string
      responses:
        '200':
          description: Attempts retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  attempts:
                    type: array
                    items:
                      $ref: '#/components/schemas/Attempt'
        '404':
          description: Task not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tasks/{id}/conversation:
    get:
      tags:
        - Tasks
      summary: Get task conversation
      description: Get full conversation history for a task with all attempts
      operationId: getTaskConversation
      parameters:
        - name: id
          in: path
          required: true
          description: Task ID
          schema:
            type: string
      responses:
        '200':
          description: Conversation retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  turns:
                    type: array
                    items:
                      $ref: '#/components/schemas/ConversationTurn'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tasks/reorder:
    put:
      tags:
        - Tasks
      summary: Reorder single task
      description: Update position and status of a single task
      operationId: reorderTask
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - taskId
                - status
                - position
              properties:
                taskId:
                  type: string
                status:
                  $ref: '#/components/schemas/TaskStatus'
                position:
                  type: integer
      responses:
        '200':
          description: Task reordered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Invalid status value or missing parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Task not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
        - Tasks
      summary: Reorder tasks (batch)
      description: Batch update position and status of multiple tasks
      operationId: reorderTasks
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tasks
              properties:
                tasks:
                  type: array
                  items:
                    type: object
                    required:
                      - id
                      - status
                      - position
                    properties:
                      id:
                        type: string
                      status:
                        $ref: '#/components/schemas/TaskStatus'
                      position:
                        type: integer
      responses:
        '200':
          description: Tasks reordered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  updated:
                    type: integer
        '207':
          description: Multi-status - some tasks failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  details:
                    type: array
                    items:
                      type: string
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/uploads:
    post:
      tags:
        - Uploads
      summary: Upload files
      description: Upload files to temporary storage (max 50MB total)
      operationId: uploadFiles
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - files
              properties:
                files:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: Files to upload
      responses:
        '201':
          description: Files uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  files:
                    type: array
                    items:
                      $ref: '#/components/schemas/UploadedFile'
        '400':
          description: No files provided or size limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/uploads/{fileId}:
    get:
      tags:
        - Uploads
      summary: Serve uploaded file
      description: Serve a previously uploaded file
      operationId: serveFile
      parameters:
        - name: fileId
          in: path
          required: true
          description: File ID (prefix match)
          schema:
            type: string
      responses:
        '200':
          description: File served successfully
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          description: Invalid file ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: File not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
        - Uploads
      summary: Delete temp file
      description: Delete a pending (temp) uploaded file
      operationId: deleteTempFile
      parameters:
        - name: fileId
          in: path
          required: true
          description: File ID (prefix match)
          schema:
            type: string
      responses:
        '200':
          description: File deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Invalid file ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Temp file not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/code/inline-edit:
    post:
      tags:
        - Code
      summary: Start inline edit session
      description: Initiate an inline code editing session with AI
      operationId: startInlineEdit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sessionId
                - basePath
                - filePath
                - selectedCode
                - instruction
              properties:
                sessionId:
                  type: string
                  description: Socket.io session ID for streaming
                basePath:
                  type: string
                  description: Project root path
                filePath:
                  type: string
                  description: Relative file path
                language:
                  type: string
                  description: Programming language
                selectedCode:
                  type: string
                  description: Code to be edited
                instruction:
                  type: string
                  description: Edit instruction
                  maxLength: 2000
                beforeContext:
                  type: string
                  description: Code context before selection
                afterContext:
                  type: string
                  description: Code context after selection
      responses:
        '200':
          description: Edit session started
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
        - Code
      summary: Cancel inline edit session
      description: Cancel an active inline edit session
      operationId: cancelInlineEdit
      parameters:
        - name: sessionId
          in: query
          required: true
          description: Session ID to cancel
          schema:
            type: string
      responses:
        '200':
          description: Session cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  cancelled:
                    type: boolean
        '400':
          description: Missing sessionId
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/language/definition:
    get:
      tags:
        - Language
      summary: Check definition support
      description: Check if definition resolution is available for a file type
      operationId: checkDefinitionSupport
      parameters:
        - name: filePath
          in: query
          description: File path to check
          schema:
            type: string
      responses:
        '200':
          description: Support status
          content:
            application/json:
              schema:
                type: object
                properties:
                  supported:
                    type: boolean
                  language:
                    type: string
                    nullable: true
                  adapter:
                    type: string
                    nullable: true
                  supportedExtensions:
                    type: array
                    items:
                      type: string
    post:
      tags:
        - Language
      summary: Resolve symbol definition
      description: Resolve symbol definition location for goto-definition functionality
      operationId: resolveDefinition
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - basePath
                - filePath
                - symbol
                - line
                - column
              properties:
                basePath:
                  type: string
                  description: Project root path
                filePath:
                  type: string
                  description: Current file path relative to basePath
                symbol:
                  type: string
                  description: Symbol name to lookup
                line:
                  type: integer
                  description: Line number (1-indexed)
                column:
                  type: integer
                  description: Column number (0-indexed)
                language:
                  type: string
                  description: Optional language hint
                fileContent:
                  type: string
                  description: Optional file content
      responses:
        '200':
          description: Definition resolved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DefinitionResult'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Language adapter not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication (required for project settings endpoints)

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
      required:
        - error

    TaskStatus:
      type: string
      enum: [todo, in_progress, in_review, done, cancelled]
      description: Status of a task in the Kanban board

    AttemptStatus:
      type: string
      enum: [running, completed, failed, cancelled]
      description: Status of an execution attempt

    CommandInfo:
      type: object
      properties:
        name:
          type: string
          description: Command name (can include : for subcommands)
        description:
          type: string
          description: Command description
        argumentHint:
          type: string
          description: Hint for command arguments
        isBuiltIn:
          type: boolean
          description: Whether this is a built-in command
        isInteractive:
          type: boolean
          description: Whether this command requires interactive mode
      required:
        - name
        - description

    CommandDetail:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        argumentHint:
          type: string
        body:
          type: string
          description: Command prompt template
      required:
        - name
        - body

    FileEntry:
      type: object
      properties:
        name:
          type: string
          description: File/directory name
        path:
          type: string
          description: Relative path from base
        type:
          type: string
          enum: [file, directory]
        size:
          type: integer
          description: File size in bytes
        gitStatus:
          type: string
          enum: [M, A, D, R, U, ?]
          description: Git status code
        children:
          type: array
          items:
            $ref: '#/components/schemas/FileEntry'
          description: Child entries (for directories)
      required:
        - name
        - path
        - type

    SearchResult:
      type: object
      properties:
        path:
          type: string
          description: Absolute path
        name:
          type: string
          description: File name
        type:
          type: string
          enum: [file, directory]
        relativePath:
          type: string
          description: Relative path from base
      required:
        - path
        - name
        - type
        - relativePath

    GitCommit:
      type: object
      properties:
        hash:
          type: string
          description: Full commit hash
        shortHash:
          type: string
          description: Short commit hash
        message:
          type: string
          description: Commit message
        author:
          type: string
          description: Author name
        date:
          type: string
          description: Relative date (e.g., "2 days ago")
        parents:
          type: array
          items:
            type: string
          description: Parent commit hashes
        refs:
          type: array
          items:
            type: string
          description: Branch/tag refs
        isLocal:
          type: boolean
          description: Whether commit is local only (not pushed)
        isMerge:
          type: boolean
          description: Whether this is a merge commit
      required:
        - hash
        - shortHash
        - message
        - author
        - date

    GitDiff:
      type: object
      properties:
        diff:
          type: string
          description: Unified diff output
        additions:
          type: integer
          description: Number of lines added
        deletions:
          type: integer
          description: Number of lines deleted
      required:
        - diff
        - additions
        - deletions

    GitFileStatus:
      type: object
      properties:
        path:
          type: string
          description: File path
        status:
          type: string
          enum: [M, A, D, R, U]
          description: Status code (Modified, Added, Deleted, Renamed, Unmerged)
        additions:
          type: integer
          description: Number of additions
        deletions:
          type: integer
          description: Number of deletions
      required:
        - path
        - status

    GitStatus:
      type: object
      properties:
        branch:
          type: string
          description: Current branch name
        staged:
          type: array
          items:
            $ref: '#/components/schemas/GitFileStatus'
          description: Staged changes
        unstaged:
          type: array
          items:
            $ref: '#/components/schemas/GitFileStatus'
          description: Unstaged changes
        untracked:
          type: array
          items:
            $ref: '#/components/schemas/GitFileStatus'
          description: Untracked files
        ahead:
          type: integer
          description: Commits ahead of remote
        behind:
          type: integer
          description: Commits behind remote
      required:
        - branch
        - staged
        - unstaged
        - untracked
        - ahead
        - behind

    Project:
      type: object
      properties:
        id:
          type: string
          description: Project ID
        name:
          type: string
          description: Project name
        path:
          type: string
          description: Project path
        createdAt:
          type: integer
          description: Creation timestamp
        settings:
          $ref: '#/components/schemas/ProjectSettings'
      required:
        - id
        - name
        - path
        - createdAt

    ProjectSettings:
      type: object
      properties:
        selectedComponents:
          type: array
          items:
            type: string
          description: Selected component IDs
        selectedAgentSets:
          type: array
          items:
            type: string
          description: Selected agent set IDs
      required:
        - selectedComponents
        - selectedAgentSets

    ContentMatch:
      type: object
      properties:
        lineNumber:
          type: integer
          description: Line number (1-indexed)
        line:
          type: string
          description: Line content
        column:
          type: integer
          description: Column where match starts
        matchLength:
          type: integer
          description: Length of match
      required:
        - lineNumber
        - line
        - column
        - matchLength

    ContentSearchResult:
      type: object
      properties:
        file:
          type: string
          description: Relative file path
        matches:
          type: array
          items:
            $ref: '#/components/schemas/ContentMatch'
          description: Matches in this file
      required:
        - file
        - matches

    FileSearchResult:
      type: object
      properties:
        name:
          type: string
          description: File name
        path:
          type: string
          description: Relative file path
        type:
          type: string
          enum: [file, directory]
        score:
          type: number
          description: Match score
        matches:
          type: array
          items:
            type: integer
          description: Match positions
      required:
        - name
        - path
        - type
        - score
        - matches

    Attempt:
      type: object
      properties:
        id:
          type: string
          description: Attempt ID
        taskId:
          type: string
          description: Parent task ID
        prompt:
          type: string
          description: User prompt
        status:
          $ref: '#/components/schemas/AttemptStatus'
        sessionId:
          type: string
          nullable: true
          description: Claude CLI session ID
        branch:
          type: string
          nullable: true
          description: Git branch name
        diffAdditions:
          type: integer
          description: Lines added
        diffDeletions:
          type: integer
          description: Lines deleted
        createdAt:
          type: integer
          description: Creation timestamp
        completedAt:
          type: integer
          nullable: true
          description: Completion timestamp
      required:
        - id
        - taskId
        - prompt
        - status

    ConversationTurn:
      type: object
      properties:
        type:
          type: string
          enum: [user, assistant]
        prompt:
          type: string
          description: User prompt (for user turns)
        messages:
          type: array
          items:
            type: object
          description: Claude output messages (for assistant turns)
        attemptId:
          type: string
          description: Associated attempt ID
        timestamp:
          type: integer
          description: Turn timestamp
        files:
          type: array
          items:
            type: object
          description: Attached files (for user turns)
      required:
        - type
        - attemptId
        - timestamp

    UploadedFile:
      type: object
      properties:
        tempId:
          type: string
          description: Temporary file ID
        filename:
          type: string
          description: Generated filename
        originalName:
          type: string
          description: Original filename
        mimeType:
          type: string
          description: File MIME type
        size:
          type: integer
          description: File size in bytes
      required:
        - tempId
        - filename
        - originalName
        - mimeType
        - size

    DefinitionResult:
      type: object
      properties:
        found:
          type: boolean
          description: Whether definition was found
        definition:
          type: object
          properties:
            filePath:
              type: string
              description: File containing definition
            line:
              type: integer
              description: Line number (1-indexed)
            column:
              type: integer
              description: Column number (0-indexed)
            symbol:
              type: string
              description: Symbol name
            kind:
              type: string
              description: Symbol kind (function, class, variable, etc.)
        preview:
          type: object
          properties:
            content:
              type: string
              description: Preview content
            startLine:
              type: integer
              description: Start line of preview
            endLine:
              type: integer
              description: End line of preview
            language:
              type: string
              description: Language for syntax highlighting
        error:
          type: string
          description: Error message if not found
      required:
        - found
